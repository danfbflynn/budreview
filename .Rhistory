thismo
yr
substr(endday,1,4)==yr-1 & substr(endday,6,7)<=12 & substr(endday,6,7)>=9)
substr(endday,1,4)==yr-1 & substr(endday,6,7)<=12 & substr(endday,6,7)>=9
substr(endday,1,4)==yr-1
substr(endday,6,7)<=12
substr(endday,6,7)>=9
endday
substr(endday,6,7)
substr(endday,6,7)>=9
substr(endday,6,7)=>9
substr(endday,6,7)>=9
substr(endday,6,7)
12>=9
substr(endday,6,7) >=9
substr(endday,6,7) >= 9
12>=9
substr(endday,6,7)>=9
substr(endday,6,7) >9
12>9
substr(endday,6,7)>9
if(substr(endday,1,4)==yr-1 & substr(endday,6,7)<=12){#when sampling occurred in previous year as study
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
thismo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr-1, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
}
prevmo
thismo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr-1, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
thismo
thismo<-
thismo<-NA
c(prevmo, thismo)
if(substr(endday,1,4)==yr-1 & substr(endday,6,7)<=12){#when sampling occurred in previous year as study
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
chillmo
i=19
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
# make sure longitudes are negative, need to be for North America
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
stday
i
nam[i,]
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
stday
if(substr(endday,1,4)==yr & substr(endday,6,7)>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
stday
yr
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
stday
prevmo
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
chillmo
endday
substr(endday,1,4)==yr & substr(endday,6,7)>=9
endday
substr(endday,1,4)==yr
substr(endday,6,7)>=9
substr(endday,6,7)<=9
endday
substr(endday,6,7)
substr(endday,6,7)<=9
10<=9
substr(endday,6,7)
x=substr(endday,6,7)
x<=9
x
as.numeric(substr(endday,6,7))
as.numeric(substr(endday,6,7))<=9
as.numeric(substr(endday,6,7))<=12
as.numeric(substr(endday,6,7))>=9
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
stday
prevmo
endday
drive="/Volumes/Expand/Climate/"
nafiles <- dir(drive)[grep("livneh", dir(drive))]
#nafiles<-dir()[grep("livneh", dir())]
for(i in 1:nrow(nam)){ # i = 2
# find this location
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
# make sure longitudes are negative, need to be for North America
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
# using d$fieldsample.date
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9){#when sampling occurred in same year as study and when collection occurred before that year's sept chilling,
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study only
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
# now loop over these year-month combo files
mins <- maxs <- vector()
for(j in c(chillmo)){ # j = "200009"
file <- file.path(drive,nafiles[grep(j, nafiles)])
jx <- nc_open(file)
#jx <- nc_open(nafiles[grep(j, nafiles)])
diff.long.cell <- abs(jx$dim$lon$vals-as.numeric(lo))
diff.lat.cell <- abs(jx$dim$lat$vals-as.numeric(la))
long.cell <- which(diff.long.cell==min(diff.long.cell))[1]
lat.cell <- which(diff.lat.cell==min(diff.lat.cell))[1]
mins <- c(mins, ncvar_get(jx,'Tmin',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
maxs <- c(maxs, ncvar_get(jx,'Tmax',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
}
tempval[[as.character(nam[i,"ID_fieldsample.date"])]] <- data.frame(Date = seq(stday, endday, by = "day"),
Tmin = mins[1:length(seq(stday, endday, by = "day"))], Tmax =maxs[1:length(seq(stday, endday, by = "day"))])
}
names(tempval)
tempval$swartz81.1980-11-01
stday
endday,
endday
tempval$nienstaedt66.1958-11-28
tempval$heide93.1990-02-15
tempval$rinne97
j
jx
stday
endday
seq(stday, endday, by = "day")
tempval[[as.character(nam[i,"ID_fieldsample.date"])]] <- data.frame(Date = seq(stday, endday, by = "day"),
Tmin = mins[1:length(seq(stday, endday, by = "day"))], Tmax =maxs[1:length(seq(stday, endday, by = "day"))])
names(tempval)
i
nam
tail(nam)
as.character(seq(stday, endday, by = "day"))
seq(stday, endday, by = "day")
tempval[[as.character(nam[i,"ID_fieldsample.date"])]] <- data.frame(Date = as.character(seq(stday, endday, by = "day")),
Tmin = mins[1:length(seq(stday, endday, by = "day"))], Tmax =maxs[1:length(seq(stday, endday, by = "day"))])
tempval$`swartz81.1980-11-01`
names(tempval)
tempval$`gianfagna85.1984-03-13`
tempval$gianfagna85.1984-03-13
jx
mins
length(mins)
nam[i,]
rm(list=ls())
options(stringsAsFactors=FALSE)
library(ncdf4)
library(dplyr)
library(Interpol.T)
library(chillR)
d <- read.csv("ospree_clean1.csv")
# make two data frames. North America and Europe, the lat longs and years.
d$continent <- tolower(d$continent)
d$datasetID <- as.character(d$datasetID)
d$provenance.lat <- as.numeric(as.character(d$provenance.lat))
d$provenance.long <- as.numeric(as.character(d$provenance.long))
d$year <- as.numeric(as.character(d$year))
d <- as_data_frame(d)
##add new column that combines datasetID and field sample.date for later indexing
d$ID_fieldsample.date<-paste(d$datasetID,d$fieldsample.date, sep=".")
# European studies
#want table with lat, long, year, field sample date for each study. there could  be multiple field sample dates for each study
#the below is dan's code for selecting out european studies using the dplyr package (does not work on Ailene's computer)
eur <- d %>% # start with the data frame
distinct(ID_fieldsample.date,.keep_all = TRUE) %>% # establishing grouping variables
filter(continent == 'europe' & year >= 1950) %>%#select out europe
select(datasetID, provenance.lat, provenance.long, year,fieldsample.date, ID_fieldsample.date)
eur <- eur[apply(eur, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
nam <- d %>% # start with the data frame
distinct(ID_fieldsample.date,.keep_all = TRUE) %>% # establishing grouping variables
filter(continent == 'north america'& year >= 1950) %>%
select(datasetID, provenance.lat, provenance.long, year,fieldsample.date, ID_fieldsample.date)
nam <- nam[apply(nam, 1, function(x) all(!is.na(x))),] # only keep rows of all not na
# these will need manual cleaning. for now use as is
eur.tempmn <- nc_open("/Volumes/Expand/Climate/tn_0.25deg_reg_v12.0.nc")
eur.tempmx <- nc_open("/Volumes/Expand/Climate/tx_0.25deg_reg_v12.0.nc")
for(i in 1:nrow(eur)){ # i = 1
# find this location
lo <- eur[i,"provenance.long"]
la <- eur[i,"provenance.lat"]
ndiff.long.cell <- abs(eur.tempmn$dim$longitude$vals-as.numeric(lo))
ndiff.lat.cell <- abs(eur.tempmn$dim$latitude$vals-as.numeric(la))
nlong.cell <- which(ndiff.long.cell==min(ndiff.long.cell))[1]
nlat.cell <- which(ndiff.lat.cell==min(ndiff.lat.cell))[1]
xdiff.long.cell <- abs(eur.tempmx$dim$longitude$vals-as.numeric(lo))
xdiff.lat.cell <- abs(eur.tempmx$dim$latitude$vals-as.numeric(la))
xlong.cell <- which(xdiff.long.cell==min(xdiff.long.cell))[1]
xlat.cell <- which(xdiff.lat.cell==min(xdiff.lat.cell))[1]
yr <- as.numeric(eur[i,"year"])
# start and end days, in days since baseline date. Set to GMT to avoid daylight savings insanity
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
# using d$fieldsample.date
if(eur[i,"fieldsample.date"]!=""){ endday <- strptime(eur[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(eur[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")
}
st <- as.numeric(as.character(stday - strptime("1950-01-01", "%Y-%m-%d", tz = "GMT")))
en <- as.numeric(as.character(endday - strptime("1950-01-01", "%Y-%m-%d", tz = "GMT")))
if(en<st){en=st}
if(endday<stday){endday=stday}
# get temperature values for this range.
# check the dim of the net cdf file, str(netcdf), and see what the order of the different dimensions are. In this case, it goes long, lat, time. So when we are moving through the file, we give it the long and lat and date of start, then move through the files by going 'up' the cube of data to the end date
mins <- ncvar_get(eur.tempmn,'tn',
start=c(nlong.cell,nlat.cell,st),
count=c(1,1,en-st+1) # this is where we move through the 'cube' to get the one vector of Temp mins
)
maxs <- ncvar_get(eur.tempmx,'tx',
start=c(xlong.cell,xlat.cell,st),
count=c(1,1,en-st+1)
)
tempval[[as.character(eur[i,"ID_fieldsample.date"])]] <- data.frame(Date = seq(stday, endday, by = "day"),
Tmin = mins, Tmax = maxs)
}
tempval <- list()
for(i in 1:nrow(eur)){ # i = 1
# find this location
lo <- eur[i,"provenance.long"]
la <- eur[i,"provenance.lat"]
ndiff.long.cell <- abs(eur.tempmn$dim$longitude$vals-as.numeric(lo))
ndiff.lat.cell <- abs(eur.tempmn$dim$latitude$vals-as.numeric(la))
nlong.cell <- which(ndiff.long.cell==min(ndiff.long.cell))[1]
nlat.cell <- which(ndiff.lat.cell==min(ndiff.lat.cell))[1]
xdiff.long.cell <- abs(eur.tempmx$dim$longitude$vals-as.numeric(lo))
xdiff.lat.cell <- abs(eur.tempmx$dim$latitude$vals-as.numeric(la))
xlong.cell <- which(xdiff.long.cell==min(xdiff.long.cell))[1]
xlat.cell <- which(xdiff.lat.cell==min(xdiff.lat.cell))[1]
yr <- as.numeric(eur[i,"year"])
# start and end days, in days since baseline date. Set to GMT to avoid daylight savings insanity
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
# using d$fieldsample.date
if(eur[i,"fieldsample.date"]!=""){ endday <- strptime(eur[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(eur[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")
}
st <- as.numeric(as.character(stday - strptime("1950-01-01", "%Y-%m-%d", tz = "GMT")))
en <- as.numeric(as.character(endday - strptime("1950-01-01", "%Y-%m-%d", tz = "GMT")))
if(en<st){en=st}
if(endday<stday){endday=stday}
# get temperature values for this range.
# check the dim of the net cdf file, str(netcdf), and see what the order of the different dimensions are. In this case, it goes long, lat, time. So when we are moving through the file, we give it the long and lat and date of start, then move through the files by going 'up' the cube of data to the end date
mins <- ncvar_get(eur.tempmn,'tn',
start=c(nlong.cell,nlat.cell,st),
count=c(1,1,en-st+1) # this is where we move through the 'cube' to get the one vector of Temp mins
)
maxs <- ncvar_get(eur.tempmx,'tx',
start=c(xlong.cell,xlat.cell,st),
count=c(1,1,en-st+1)
)
tempval[[as.character(eur[i,"ID_fieldsample.date"])]] <- data.frame(Date = seq(stday, endday, by = "day"),
Tmin = mins, Tmax = maxs)
}
names(tempval)
tempval[140]
tempval[140,,]
tempval[140,]
tempval$laube14b.
drive="/Volumes/Expand/Climate/"
nafiles <- dir(drive)[grep("livneh", dir(drive))]
for(i in 1:nrow(nam)){ # i = 1
# find this location
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
# make sure longitudes are negative, need to be for North America
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
# using d$fieldsample.date
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9){#when sampling occurred in same year as study and when collection occurred before that year's sept chilling,
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study only
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
#check
print(nam[i,]);print(stday);print(endday);print(chillmo)
# now loop over these year-month combo files
mins <- maxs <- vector()
for(j in c(chillmo)){ # j = "200009"
file <- file.path(drive,nafiles[grep(j, nafiles)])
jx <- nc_open(file)
#jx <- nc_open(nafiles[grep(j, nafiles)])
diff.long.cell <- abs(jx$dim$lon$vals-as.numeric(lo))
diff.lat.cell <- abs(jx$dim$lat$vals-as.numeric(la))
long.cell <- which(diff.long.cell==min(diff.long.cell))[1]
lat.cell <- which(diff.lat.cell==min(diff.lat.cell))[1]
mins <- c(mins, ncvar_get(jx,'Tmin',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
maxs <- c(maxs, ncvar_get(jx,'Tmax',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
}
tempval[[as.character(nam[i,"ID_fieldsample.date"])]] <- data.frame(Date = as.character(seq(stday, endday, by = "day")),
Tmin = mins[1:length(seq(stday, endday, by = "day"))], Tmax =maxs[1:length(seq(stday, endday, by = "day"))])
}
print(paste(c("startday",stday))
)
stday
print(paste("startday:",stday))
print(endday)
names(nam)
nam
nam[which(nam$datasetID=="guak98")]
nam[which(nam$datasetID=="guak98"),]
which(nam$datasetID=="guak98")
i=8
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
nam[i,]
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
endday
substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9
substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9
substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9
substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9
substr(endday,1,4)<yr
substr(endday,1,4)==yr-1
as.numeric(substr(endday,6,7))<=12
as.numeric(substr(endday,6,7))<9
as.numeric(substr(endday,1,4))
strptime(paste(as.numeric(substr(endday,1,4))-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
as.numeric(substr(endday,1,4))-1
endday
yr
as.numeric(substr(endday,1,4))
thismo <- paste(as.numeric(substr(endday,1,4)), formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
thismo
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))<9){#when sampling occurred in previous year as study, NOT during the fall
stday <- strptime(paste(as.numeric(substr(endday,1,4))-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(as.numeric(substr(endday,1,4))-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(as.numeric(substr(endday,1,4)), formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
chillmo
drive="/Volumes/Expand/Climate/"
nafiles <- dir(drive)[grep("livneh", dir(drive))]
#nafiles<-dir()[grep("livneh", dir())]
for(i in 1:nrow(nam)){ # i = 1
# find this location
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
# make sure longitudes are negative, need to be for North America
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
# using d$fieldsample.date
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9){#when sampling occurred in same year as study and when collection occurred before that year's sept chilling,
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study only
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study between sept and dec
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))<9){#when sampling occurred in previous year as study, NOT during the fall
stday <- strptime(paste(as.numeric(substr(endday,1,4))-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(as.numeric(substr(endday,1,4))-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(as.numeric(substr(endday,1,4)), formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
#check
#print(nam[i,]);print(paste("startday:",stday));print(endday);print(chillmo)
# now loop over these year-month combo files
mins <- maxs <- vector()
for(j in c(chillmo)){ # j = "200009"
file <- file.path(drive,nafiles[grep(j, nafiles)])
jx <- nc_open(file)
#jx <- nc_open(nafiles[grep(j, nafiles)])
diff.long.cell <- abs(jx$dim$lon$vals-as.numeric(lo))
diff.lat.cell <- abs(jx$dim$lat$vals-as.numeric(la))
long.cell <- which(diff.long.cell==min(diff.long.cell))[1]
lat.cell <- which(diff.lat.cell==min(diff.lat.cell))[1]
mins <- c(mins, ncvar_get(jx,'Tmin',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
maxs <- c(maxs, ncvar_get(jx,'Tmax',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
}
tempval[[as.character(nam[i,"ID_fieldsample.date"])]] <- data.frame(Date = as.character(seq(stday, endday, by = "day")),
Tmin = mins[1:length(seq(stday, endday, by = "day"))], Tmax =maxs[1:length(seq(stday, endday, by = "day"))])
}
i
lo <- nam[i,"provenance.long"]
la <- nam[i,"provenance.lat"]
# make sure longitudes are negative, need to be for North America
if(lo > 0) { lo = lo*-1 }
yr <- as.numeric(nam[i,"year"])
# using d$fieldsample.date
if(nam[i,"fieldsample.date"]!=""){endday <- strptime(nam[i,"fieldsample.date"],"%Y-%m-%d", tz = "GMT")}
if(nam[i,"fieldsample.date"]==""){endday <- strptime(paste(yr, "04-30", sep="-"),"%Y-%m-%d", tz = "GMT")#if no sampling date given, use april 30
}
substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))<=9){#when sampling occurred in same year as study and when collection occurred before that year's sept chilling,
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(yr, formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study only
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9
if(substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in same year as study and after chilling started that year
stday <- strptime(paste(yr, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
substr(endday,1,4)==yr & as.numeric(substr(endday,6,7))>=9
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9){#when sampling occurred in previous year as study between sept and dec
stday <- strptime(paste(yr-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(yr-1, formatC(9:substr(endday,6,7), width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-whenever collection occured)}
chillmo<-prevmo
}
substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))>=9
if(substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))<9){#when sampling occurred in previous year as study, NOT during the fall
stday <- strptime(paste(as.numeric(substr(endday,1,4))-1, "09-01", sep="-"),"%Y-%m-%d", tz="GMT")
prevmo <- paste(as.numeric(substr(endday,1,4))-1, formatC(9:12, width=2, flag="0"), sep="");# use previous year's fall months of chilling (Sept-Dec)
endmo<-substr(endday,6,7);#month of sampling date
thismo <- paste(as.numeric(substr(endday,1,4)), formatC(1:endmo, width=2, flag="0"), sep="")#months from current year of chilling, through sampling date (Jan-whenever sampled)
chillmo<-c(prevmo, thismo)
}
substr(endday,1,4)==yr-1 & as.numeric(substr(endday,6,7))<=12  & as.numeric(substr(endday,6,7))<9
stday
prevmo
endmo
thismo
chillmo
mins <- maxs <- vector()
for(j in c(chillmo)){ # j = "200009"
file <- file.path(drive,nafiles[grep(j, nafiles)])
jx <- nc_open(file)
#jx <- nc_open(nafiles[grep(j, nafiles)])
diff.long.cell <- abs(jx$dim$lon$vals-as.numeric(lo))
diff.lat.cell <- abs(jx$dim$lat$vals-as.numeric(la))
long.cell <- which(diff.long.cell==min(diff.long.cell))[1]
lat.cell <- which(diff.lat.cell==min(diff.lat.cell))[1]
mins <- c(mins, ncvar_get(jx,'Tmin',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
maxs <- c(maxs, ncvar_get(jx,'Tmax',start=c(long.cell,lat.cell,1),count=c(1,1,-1)))
}
j
file <- file.path(drive,nafiles[grep(j, nafiles)])
jx <- nc_open(file)
file
file <- file.path(drive,nafiles[grep(j, nafiles)])
file
chillmo
file <- file.path(drive,nafiles[grep(j, nafiles)])
file
nafiles[grep(j, nafiles)]
grep(j, nafiles)
j
nafiles
nam$fieldsample.date
eur$fieldsample.date
nam$fieldsample.date
