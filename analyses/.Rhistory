annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "ILEMUC")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "BETALL")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 135, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 137, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
ilemuc<-ggplot(ile, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Ilex mucronata")
betall<-ggplot(bet, aes(x=doy, y=risk)) + geom_line() + coord_cartesian(ylim=0:20) +
annotate("rect", xmin=82, xmax=97, ymin=1, ymax=6, alpha=0.1, color="red") +
xlab("Day of Year") + ylab("Frost Damage Risk") +
annotate("text", x = 140, y = 18, label = "Betula alleghaniensis")
grid.arrange(ilemuc, betall, ncol=1, nrow=2)
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(ncdf4)
library(Interpol.T)
library(chillR)
library(raster)
library(maptools)
library(rgeos)
library(rgdal)
raster1<-brick("~/Desktop/tn_0.25deg_reg_v16.0.nc", varname="tn", sep="")
eur.temp<-nc_open("~/Desktop/tn_0.25deg_reg_v16.0.nc")
raster1<-brick("//WeldShare/Wolkovich Lab/Budburst Review - Ospree/Climate Data/tn_0.25deg_reg_v15.0.nc", varname="tn", sep="")
eur.temp <- nc_open("//128.103.155.31/WeldShare/Wolkovich Lab/Budburst Review - Ospree/Climate Data/tn_0.25deg_reg_v15.0.nc")
plot(raster1[[45]])
#raster1 <- setMinMax(raster1)
#length(doy)/365
doy<-ncvar_get(eur.temp, "time")
doy<-as.Date(doy, origin="1950-01-01")
day<-substr(doy, 9,10)
year<-as.numeric(substr(doy, 1, 4))
month<-as.numeric(substr(doy, 6, 7))
timevec<-paste(year, month, day, sep="-")
years.vec<-as.character(timevec, format="Y-%m-%d")
year<-as.numeric(substr(years.vec, 1, 4))
#doy.vec<-as.POSIXlt(names(raster1), format="X%j")
dates<-as.Date(years.vec)
names(raster1)<-dates
empty.raster<-raster1[[1]]
values(empty.raster)<-NA
years<-1950:2016
leaps <- function(x) {
m <- c()
for(i in 1:50) {
year.i <- years[which(((years %% 4 == 0) & (years %% 100 !=0) | (years %% 400 == 0)))]
m <- c(m, year.i)
}
return(m)
}
leap.years<-as.data.frame(leaps(1))
leap.years<-leap.years[!duplicated(leaps(1)),]
#year<-1950:2016
empty.raster<-raster1[[1]]
num.false.spring.year<-list()
#dates.false.spring<-list()
for(i in 1951:1983){#i=1952
print(i)
year.i<-i
is.leap<-ifelse(year.i%in%leap.years,TRUE,FALSE)
sequence.years<-which(year==year.i)
#length(sequence.years)
raster.sub<-subset(raster1,sequence.years)
#numnonas<-sum(!is.na(values(raster.sub[[1]])))
rast.array<-array(75,dim=c(ncell(raster.sub),181))
if(is.leap){
for(j in 75:181){ ## you need to change
print(paste(year.i,j))
rast.array[,j]<-values(raster.sub[[j]])
}
}
if(!is.leap){
for(j in 75:181){ ## you need to change
print(paste(year.i,j))
rast.array[,j]<-values(raster.sub[[j]])
}
}
#dates.fs<-apply(rast.array, 1, function(x){ifelse(x<=-2.2, x, 0)})
num.false.spring<-apply(rast.array,1,function(x){sum(ifelse(x<=-2.2,1,0))})
non.nas.ids<-which(!is.na(num.false.spring))
#values(emp.rast)<-NA
values(empty.raster)<- NA
#non.nas.dates<-which(!is.na(dates.fs))
#plot(raster1[[1]])
values(empty.raster)[non.nas.ids]<- num.false.spring[!is.na(num.false.spring)]
#values(empty.raster)[non.nas.dates]<- dates.fs[!is.na(dates.fs)]
#plot(empty.raster)
#dates.false.spring[[i]]<- empty.raster
num.false.spring.year[[i]]<-empty.raster
}
length(num.false.spring.year)
final.raster.preCC<-stack(unlist(num.false.spring.year))
summed.false.springs.preCC<-calc(final.raster.preCC,sum)
fs.years.pre<-calc(final.raster.preCC, function(x) {sum(ifelse(x>=1,1,0))})
writeRaster(fs.years.pre,"~/Documents/git/regionalrisk/analyses/output/fs.30.pre", bylayer=TRUE,format="GTiff")
install.packages("gdal")
library(gdal)
library(rgdal)
install.packages("gdalUtils")
library("gdalUtils", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
install.packages("rgeos", repos="http://R-Forge.R-project.org", type="source")
install.packages("rgeos", repos = "http://R-Forge.R-project.org", type = "source")
library(rgeos)
install.packages("rgdal", repos="http://R-Forge.R-project.org", type="source")
install.packages("rgdal", type="source")
library(rgdal)
install.packages('rgdal',repos="http://www.stats.ox.ac.uk/pub/RWin")
rgdal::writeRaster(fs.years.post,"~/Documents/git/regionalrisk/analyses/output/fs.postCC", bylayer=TRUE,format="GTiff")
install.packages("rgeos", type="source")
install.packages("rgeos", type = "source")
install.packages("rgeos", repos="http://R-Forge.R-project.org", type="source")
install.packages(c('rgdal','rgeos'),repos="http://www.stats.ox.ac.uk/pub/RWin")
library("rgeos", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
detach("package:rgeos", unload=TRUE)
install.packages("rgdal")
install.packages("installr")
updateR()
install.packages("updateR")
version
if(!require(installr)) {
install.packages("installr");
require(installr)
}
library(installr)
version
load("/Users/CatherineChamberlain/Desktop/Moransel.RData")
rm(bcoord, bcoords, bprep, distgab, listw, nb, nbgab, test, xymat)
mem.select<-as.data.frame(moransel$MEM.select)
View(mem.select)
save.image("~/Downloads/MEM_forNacho.RData")
head(bb)
unique(bb$fs.count)
rm(moransel, MEM_model, MEM.moransel)
unique(y)
bb$check<-ave(bb$fs, bb$PEP_ID, bb$species, FUN=sum)
head(bb)
sort(unique(bb$check))
length(unique(bb$year))
sort(unique(y))
bb$check2<-ave(bb$fs, bb$PEP_ID, FUN=sum)
head(bb)
bb$fs.num<-ave(bb$fs, bb$PEP_ID, bb$species, bb$year, FUN=sum)
unique(bb$fs.num)
df<-bb
df$fs.num<-ave(df$fs, df$sp)
df$fs.sd<-ave(df$fs, df$sp, FUN=sd)
df$sp<-ifelse(df$sp==1, "A.hippocastanum", df$sp)
df$sp<-ifelse(df$sp==2, "A.glutinosa", df$sp)
df$sp<-ifelse(df$sp==3, "B.pendula", df$sp)
df$sp<-ifelse(df$sp==4, "F.sylvatica", df$sp)
df$sp<-ifelse(df$sp==5, "F.excelsior", df$sp)
df$sp<-ifelse(df$sp==6, "Q.robar", df$sp)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
library(dplyr)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
df$fs.lat<-ave(df$fs, df$latr)
#pre<-bb%>%filter(year>1950)%>%filter(year<=1983)
pre<-bb
pre$fs<-ave(pre$fs, pre$PEP_ID, pre$species, FUN=sum)
pre$sp<-as.numeric(as.factor(pre$species))
pre$mat<-ave(pre$mat, pre$PEP_ID)
pre$lat<-as.numeric(pre$lat)
pre$long<-as.numeric(pre$long)
pre<-pre%>%dplyr::select(lat.long, lat, long, mat, sp, fs)
pre.bx<-pre[!duplicated(pre),]
## subsetting data, preparing genus variable, removing NAs
pre.mat.prepdata <- subset(pre.bx, select=c("fs", "mat", "sp", "lat", "long"))
pre.mat.stan <- pre.mat.prepdata[complete.cases(pre.mat.prepdata),]
df$latr<-round(df$lat, digits=2)
######### Plotting time! ##########
df<-pre.mat.stan
df$fs.num<-ave(df$fs, df$sp)
df$fs.sd<-ave(df$fs, df$sp, FUN=sd)
df$sp<-ifelse(df$sp==1, "A.hippocastanum", df$sp)
df$sp<-ifelse(df$sp==2, "A.glutinosa", df$sp)
df$sp<-ifelse(df$sp==3, "B.pendula", df$sp)
df$sp<-ifelse(df$sp==4, "F.sylvatica", df$sp)
df$sp<-ifelse(df$sp==5, "F.excelsior", df$sp)
df$sp<-ifelse(df$sp==6, "Q.robar", df$sp)
dx<-df%>%dplyr::select(-fs, -mat, -lat, -long)
dx<-dx[!duplicated(dx),]
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
#install.packages("rstan", repos = "https://cloud.r-project.org/", dependencies=TRUE)
library(ggplot2)
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
diff<-ggplot(dx, aes(x=as.factor(sp), y=fs.num)) + geom_point(col=dx$sp) +
geom_linerange(aes(ymin=fs.num-fs.sd, ymax=fs.num+fs.sd), alpha=0.3) +
ylab(expression("Years with False Springs")) +
theme(panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.title.x=element_blank(),
axis.text.x = element_text(face = "italic", angle=45, vjust=0.5), axis.text=element_text(size=10))
plot(diff)
df$latr<-round(df$lat, digits=2)
df$fs.lat<-ave(df$fs, df$latr)
dl<-df%>%dplyr::select(fs.lat, latr, sp )
dl<-dl[!duplicated(dl),]
dl$latr<-as.numeric(dl$latr)
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=sp)
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=as.factor(sp))
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(col=as.factor(sp)) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
lat.spp<-ggplot(dl, aes(latr, fs.lat)) + xlab("Latitude") + geom_point(aes(col=as.factor(sp))) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
plot(lat.spp)
df$fs.mat<-ave(df$fs, df$mat)
dm<-df%>%dplyr::select(fs.mat, mat, sp )
dm<-dm[!duplicated(dm),]
dm$matr<-as.numeric(dm$matr)
mat.spp<-ggplot(dm, aes(mat, fs.mat)) + xlab("Mean Annual Temperature") + geom_point(aes(col=as.factor(sp))) +
ylab("Number of False Springs")  + geom_smooth(aes(col=as.factor(sp)),method="lm", se=FALSE) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),
legend.key=element_blank())
plot(mat.spp)
rm(list=ls()) # remove everything currently held in the R memory
options(stringsAsFactors=FALSE)
graphics.off()
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)
library(extrafont)
## Let's make the data...
d<- data.frame(study=c("Sorbus aucuparia - 50% (Lenz et al., 2016)", "Prunus avium - 50% (Lenz et al., 2016)", "Tilia platyphyllos - 50% (Lenz et al., 2016)",
"Acer pseudoplatanus - 50% (Lenz et al., 2016)", "Fagus sylvatica - 50% (Lenz et al., 2016)", "All species - hard freeze (Schwartz, 1993))",
"All species - soft freeze (Augspurger, 2013)", "Eucalyptus pauciflora (Barker et al., 2005)", "All species (Peterson & Abatzoglou, 2014)",
"All species (Cannell & Smith, 1986)", "Vaccinium spp. (Longstroth, 2012)", "Rosaceae - 10% (Longstroth, 2013)", "Rosaceae - 90% (Longstroth, 2013)",
"Wheat - 10 to 90% (Barlow et al., 2015)", "Wheat - 100% (Barlow et al., 2015)", "Rice - 100% (Sanchez et al., 2013)", "Corn - 100% (Sanchez et al., 2013)", "Wheat - 100% (Sanchez et al., 2013)"),
phase=c("Vegetative", "Vegetative", "Vegetative", "Vegetative", "Vegetative", "Both", "Both", "Both", "Both", "Both",
"Floral", "Vegetative", "Vegetative", "Floral", "Vegetative", "Vegetative", "Vegetative", "Vegetative"),
sector=c("Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial", "Ecologicial",
"Ecologicial", "Ecologicial", "Ecologicial", "Agronomic", "Agronomic", "Agronomic", "Agronomic",
"Agronomic", "Agronomic", "Agronomic", "Agronomic", "Agronomic"),
temperature=c(-7.4, -8.5, -7.4, -6.7, -4.8, -2.2, -1.7, -5.8, -2.2, 2, -2.2, -7.2, -13.3, -4.5,
-5.5, 4.7, -1.8, -17.2),
sd=c(4, 5, 3, 4, 3, 0, 0, 0, 0, 1, 2.2, 0, 0, 0.5, 1.5, 1.3, 1.9, 1.2))
d$alph<-ifelse(d$sector=="Agronomic", 1, 2)
d$dataset<-reorder(d$study, d$alph)
d$dataset <- factor(d$dataset, levels = d$dataset[order(d$sector, d$temperature)])
my.xlab = expression(paste("Temperature Threshold ", degree,"C"))
temp<-ggplot(d, aes(x=dataset, y=temperature)) +
geom_linerange(aes(ymin=temperature-sd, ymax=temperature+sd, color=sector), alpha=0.3) +
geom_point(aes(shape=phase, color=sector)) + ylab(my.xlab) + theme(axis.title.y=element_blank()) +
geom_hline(yintercept=0, linetype=2) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")) +
ylim(c(-20, 10))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp +coord_flip()
temp +coord_flip()
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp<-ggplot(d, aes(x=dataset, y=temperature)) +
geom_linerange(aes(ymin=temperature-sd, ymax=temperature+sd, color=sector), alpha=0.3) +
geom_point(aes(shape=phase, color=sector)) + ylab(my.xlab) + theme(axis.title.y=element_blank()) +
geom_hline(yintercept=0, linetype=2) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")) +
ylim(c(-20, 10))
temp<- temp + scale_x_discrete(labels=c("All species - soft freeze (Augspurger, 2013)"="All species - soft freeze (Augspurger, 2013)",
"All species (Peterson & Abatzoglou, 2014)"="All species (Peterson & Abatzoglou, 2014)",
"All species - hard freeze (Schwartz, 1993))"="All species - hard freeze (Schwartz, 1993))",
"Fagus sylvatica - 50% (Lenz et al., 2016)" = expression(paste(italic("Fagus sylvatica"),  "- 50% (Lenz et al., 2016)")),
"Eucalyptus pauciflora (Barker et al., 2005)"=expression(paste(italic("Eucalyptus pauciflora"), "(Barker et al., 2005)")),
"Acer pseudoplatanus - 50% (Lenz et al., 2016)"=expression(paste(italic("Acer pseudoplatanus"), "- 50% (Lenz et al., 2016)")),
"Tilia platyphyllos - 50% (Lenz et al., 2016)"=expression(paste(italic("Tilia platyphyllos"), "- 50% (Lenz et al., 2016)")),
"Sorbus aucuparia - 50% (Lenz et al., 2016"=expression(paste(italic("Sorbus aucuparia"), "- 50% (Lenz et al., 2016")),
"Prunus avium - 50% (Lenz et al., 2016)"=expression(paste(italic("Prunus avium"), "- 50% (Lenz et al., 2016)")),
"Rice - 100% (Sanchez et al., 2013)"="Rice - 100% (Sanchez et al., 2013)",
"All species (Cannell & Smith, 1986)"="All species (Cannell & Smith, 1986)",
"Corn - 100% (Sanchez et al., 2013)"="Corn - 100% (Sanchez et al., 2013)",
"Vaccinium spp. (Longstroth, 2012)"=expression(paste(italic("Vaccinium spp."), "(Longstroth, 2012)")),
"Wheat - 10 to 90% (Barlow et al., 2015)"="Wheat - 10 to 90% (Barlow et al., 2015)",
"Wheat - 100% (Barlow et al., 2015)"="Wheat - 100% (Barlow et al., 2015)",
"Rosaceae - 10% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 10% (Longstroth, 2013)")),
"Rosaceae - 90% (Longstroth, 2013)"=expression(paste(italic("Rosaceae"), "- 90% (Longstroth, 2013)")),
"Wheat - 100% (Sanchez et al., 2013)"="Wheat - 100% (Sanchez et al., 2013)"))
temp +coord_flip()
## Take 2: February 2017! ##
## Take 3: July 2017! ## Nacho's clean code to run stan models on Ospree
############################################
## housekeeping
rm(list=ls())
options(stringsAsFactors = FALSE)
library(ggplot2)
library(rstanarm)
library(brms)
setwd("~/Documents/git/ospree/analyses")
######Above is all old code. Below is what formats the data properly in accordance with other models
source("lat_analysis/source/bbdataplease.R")
## (2) Deal with species
dim(bb.noNA)
d <- bb.noNA
source("bb_analysis/source/speciescomplex.R")
bb.noNA.wtaxa <- d
dim(bb.noNA.wtaxa)
unique(bb.noNA.wtaxa$complex)
bb.wlab<-bb.noNA.wtaxa
###filter for species of interest
tt <- table(bb.wlab$complex)
bb.wlab <- subset(bb.wlab, complex %in% names(tt[tt > 100]))
####below is handled in source i think
columnstokeep <- c("datasetID", "genus", "species", "varetc", "woody", "forcetemp",
"photoperiod_day", "response", "response.time", "Total_Utah_Model",
"complex", "provenance.lat")
bb.wlab.sm <- subset(bb.wlab, select=columnstokeep)
unique(bb.wlab.sm$complex)
table(bb.wlab.sm$complex)
myspp<-c("Betula_pendula", "Betula_pubescens", "Fagus_sylvatica", "Picea_abies", "Picea_glauca",
"Pseudotsuga_menziesii", "Ribes_nigrum")
bb.wlab.sm<-dplyr::filter(bb.wlab.sm, complex%in%myspp)
## make a bunch of things numeric (eek!)
bb.wlab.sm$force <- as.numeric(bb.wlab.sm$forcetemp)
bb.wlab.sm$photo <- as.numeric(bb.wlab.sm$photoperiod_day)
bb.wlab.sm$chill <- as.numeric(bb.wlab.sm$Total_Utah_Model)
bb.wlab.sm$resp <- as.numeric(bb.wlab.sm$response.time)
bb.wlab.sm$lat<-as.numeric(bb.wlab.sm$provenance.lat)
## subsetting data, preparing genus variable, removing NAs
ospr.prepdata <- subset(bb.wlab.sm, select=c("resp", "chill", "photo", "force", "complex", "lat"))
dim(subset(bb.wlab.sm, is.na(chill)==FALSE & is.na(photo)==FALSE & is.na(force)==FALSE
& is.na(lat)==FALSE))
ospr.stan <- ospr.prepdata[complete.cases(ospr.prepdata),]
ospr.stan$complex <- as.numeric(as.factor(ospr.stan$complex))
#lat.stan<-stan_glmer(resp~chill+photo+force+lat+(1|complex), data=ospr.stan) - ugly pp_checks
ospr.stan$resp<-as.integer(ospr.stan$resp+1)
ospr.stan<-ospr.stan[(ospr.stan$resp!=1000),]
ospr.stan$sm.chill<-ospr.stan$chill/240
hist(ospr.stan$sm.chill)
lat.brm<-brm(resp~sm.chill+photo+force+lat+photo:lat+(1|complex)+
(sm.chill-1|complex)+(photo-1|complex)+
(force-1|complex)+(lat-1|complex)+
(photo:lat-1|complex), data=ospr.stan, family=negbinomial)
m<-lat.brm
m.int<-posterior_interval(m)
sum.m<-summary(m)
cri.f<-as.data.frame(sum.m$fixed[,c("Estimate", "l-95% CI", "u-95% CI")])
cri.f<-cri.f[-1,] #removing the intercept
fdf1<-as.data.frame(rbind(as.vector(cri.f[,1]), as.vector(cri.f[,2]), as.vector(cri.f[,3])))
fdf2<-cbind(fdf1, c(0, 0, 0) , c("Estimate", "2.5%", "95%"))
names(fdf2)<-c(rownames(cri.f), "complex", "perc")
cri.r<-(ranef(m, summary = TRUE, robust = FALSE,
probs = c(0.025, 0.975)))$complex
cri.r2<-cri.r[, ,-1]
cri.r2<-cri.r2[,-2,]
dims<-dim(cri.r2)
twoDimMat <- matrix(cri.r2, prod(dims[1:2]), dims[3])
mat2<-cbind(twoDimMat, c(rep(1:7, length.out=21)), rep(c("Estimate", "2.5%", "95%"), each=7))
df<-as.data.frame(mat2)
names(df)<-c(rownames(cri.f), "complex", "perc")
dftot<-rbind(fdf2, df)
dflong<- tidyr::gather(dftot, var, value, sm.chill:`photo:lat`, factor_key=TRUE)
#adding the coef estiamtes to the random effect values
for (i in seq(from=1,to=nrow(dflong), by=24)) {
for (j in seq(from=3, to=20, by=1)) {
dflong$value[i+j]<- as.numeric(dflong$value[i+j]) + as.numeric(dflong$value[i])
}
}
dflong$rndm<-ifelse(dftot$complex>0, 2, 1)
dfwide<-tidyr::spread(dflong, perc, value)
dfwide[,4:6] <- as.data.frame(lapply(c(dfwide[,4:6]), as.numeric ))
dfwide$complex<-as.factor(dfwide$complex)
pd <- position_dodgev(height = -0.5)
estimates<-c("Chill Hours", "Photoperiod", "Forcing", "Latitude", "Forcing x Photoperiod",
"Forcing x Chill Portions", "Photoperiod x Chill Portions","Forcing x Latitude",
"Photoperiod x Latitude", "Chill Portions x Latitude")
estimates<-c("Chill Hours", "Photoperiod", "Forcing", "Latitude", "Photoperiod x Latitude")
dfwide$legend<-factor(dfwide$complex,
labels=c("Overall Effects","B. pendula","B. pubescens","F. sylvatica",
"P. abies","Picea glauca", "Pseudotsuga menziesii", "Ribes nigrum"))
estimates<-rev(estimates)
fig1 <-ggplot(dfwide, aes(x=Estimate, y=var, color=legend, size=factor(rndm), alpha=factor(rndm)))+
geom_point(position =pd)+
geom_errorbarh(aes(xmin=(`2.5%`), xmax=(`95%`)), position=pd, size=.5, height =0, width=0)+
geom_vline(xintercept=0)+
scale_colour_manual(values=c("blue", "firebrick3", "orangered1","orange3","sienna2","sienna4", "green4", "purple2"),
breaks=c("Overall Effects", "B. pendula","B. pubescens","F. sylvatica",
"P. abies", "Picea glauca","Pseudotsuga menziesii", "Ribes nigrum"))+
scale_size_manual(values=c(3, 2, 2, 2, 2, 2, 2, 2)) +
scale_shape_manual(labels="", values=c("1"=16,"2"=16))+
scale_alpha_manual(values=c(1, 0.5)) +
guides(size=FALSE, alpha=FALSE) +
scale_y_discrete(limits = rev(unique(sort(dfwide$var))), labels=estimates) + ylab("") +
labs(col="Effects") + theme(legend.box.background = element_rect(),
legend.title=element_blank(), legend.key.size = unit(0.05, "cm")) +
xlab(expression(atop("Model Estimate of Days to Budburst")))
fig1
## plotting
library(ggstance)
pd <- position_dodgev(height = -0.5)
fig1 <-ggplot(dfwide, aes(x=Estimate, y=var, color=legend, size=factor(rndm), alpha=factor(rndm)))+
geom_point(position =pd)+
geom_errorbarh(aes(xmin=(`2.5%`), xmax=(`95%`)), position=pd, size=.5, height =0, width=0)+
geom_vline(xintercept=0)+
scale_colour_manual(values=c("blue", "firebrick3", "orangered1","orange3","sienna2","sienna4", "green4", "purple2"),
breaks=c("Overall Effects", "B. pendula","B. pubescens","F. sylvatica",
"P. abies", "Picea glauca","Pseudotsuga menziesii", "Ribes nigrum"))+
scale_size_manual(values=c(3, 2, 2, 2, 2, 2, 2, 2)) +
scale_shape_manual(labels="", values=c("1"=16,"2"=16))+
scale_alpha_manual(values=c(1, 0.5)) +
guides(size=FALSE, alpha=FALSE) +
scale_y_discrete(limits = rev(unique(sort(dfwide$var))), labels=estimates) + ylab("") +
labs(col="Effects") + theme(legend.box.background = element_rect(),
legend.title=element_blank(), legend.key.size = unit(0.05, "cm")) +
xlab(expression(atop("Model Estimate of Days to Budburst")))
fig1
lat.pois<-stan_glmer(resp~sm.chill+photo+force+lat+(1|complex), data=ospr.stan, family=poisson)
